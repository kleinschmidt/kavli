---
author: "Dave F. Kleinschmidt"
affiliation: "Princeton Neuroscience Institute"
title: "Prediction and adaptation"
output: 
  revealjs::revealjs_presentation:
    self_contained: false
    keep_md: true
    transition: none
    background_transition: none
    reveal_options:
      center: true
      history: true
      notes: true

---

```{r}

library(tidyverse)
library(magrittr)

library(beliefupdatr)

```

# Adaptation is ubiquitous in brain and behavior

## Adaptation is ubiquitous in **brain** and behavior

* Less BOLD signal from repeated stimuli
* Lower single neuron firing from repeated stimuli
* Changes in preferred stimuli based on ensemble

## Adaptation is ubiquitous in brain and **behavior**

# **_WHAT DOES IT MEAN??_**

## Questions

> * Why does the brain adapt?
> * What _is_ adaptation?
> * What does it have to do with prediction?

## Questions

* Why does the brain adapt?
    * **Computational** reasons: accurate inference
    * **Efficiency** reasons: limited resources
* What _is_ adaptation?
* What does it have to do with prediction?

## Questions

* Why does the brain adapt?
    * **Computational** reasons: accurate inference
    * **Efficiency** reasons: limited resources
* What _is_ adaptation?
    * Distributional learning
    * (Inference at a higher level)
* What does it have to do with prediction?

# Inference and prediction

## How do you know what someone's said?

# Bayesian mind reading

```{r}

d <- supunsup::supunsup_clean %>%
  filter(supCond == 'unsupervised') %>%
  select(vot, trueCat, respCat, trial, bvotCond, subject)

## fit_inc <-
##   infer_prior_beliefs(df = d,
##                       cue = 'vot',
##                       category = 'trueCat',
##                       response = 'respCat',
##                       condition = 'bvotCond',
##                                         # use first subject in each condition
##                                         # to determine exposure statistics:
##                       ranefs = 'subject',
##                       n_blocks = 10,    # discretize trials into 10 blocks
##                       iter = 500, chains = 4, init = 0) %T>%
##   print(digits=1, pars=c('kappa_0', 'nu_0', 'mu_0', 'sigma_0', 'lapse_rate'))
## saveRDS(fit_inc, "fit_inc.rds")
fit_inc <- readRDS("fit_inc.rds")

samples <- rstan::extract(fit_inc)


most_block_samples <-
  extract_updated_samples(fit_inc, c("b", "p"), levels(d$bvotCond)) %>%
  filter(block %in% seq(1, 10, by=3)) %>%
  group_by(block) %>%
  nest() %>%
  unnest(map(data, beliefupdatr:::updated_samples_predict_lhood, x=seq(-40, 100, by=5)))
  
lapse_rates <-
  rstan::extract(fit_inc) %>%
  beliefupdatr:::rename_dims('lapse_rate', c("iterations", "block")) %>%
  beliefupdatr:::melt_samples(c('lapse_rate'))



block10_samples <-
  extract_updated_samples(fit_inc, c("b", "p"), levels(d$bvotCond)) %>%
  filter(block==max(block)) %>%
  beliefupdatr::updated_samples_predict_lhood(seq(-40, 100, by=5))

most_block_dat <-
  d %>%
  mutate(block= ntile(trial, 10)) %>%
  filter(block %in% unique(most_block_samples$block)) %>%
  group_by(block, subject, vot) %>%
  mutate(resp_p = mean(respCat == "p"),
         group = bvotCond)

most_block_class_summary <-
  most_block_samples %>%
  spread(category, pred) %>%
  left_join(lapse_rates) %>%
  mutate(prob_p = p / (p+b),
         prob_p_lapse = lapse_rate/2 + (1-lapse_rate)*prob_p) %>%
  group_by(block, group, x) %>%
  summarise_each(funs(med=median, low=quantile(., 0.25), high=quantile(., 0.75)),
                 prob_p_lapse)

most_block_class_summary %>%
  ggplot(aes(x=x, y=med, color=group, fill=group)) +
  geom_ribbon(aes(ymin=low, ymax=high), alpha=0.2, color=NA) +
  geom_line() +
  geom_pointrange(data=most_block_dat, aes(x = vot, y=resp_p), stat='summary', fun.data='mean_cl_boot') +
  facet_grid(block~group)

# facet by 
most_block_dat %>%
  ggplot(aes(x=vot, y=resp_p, color=group, alpha=block, group=interaction(group, block))) +
  geom_point(stat='summary', fun.y=mean) +
  geom_line(stat='summary', fun.y=mean) +  
  facet_grid(.~group)

most_block_class_summary %>%
  ggplot(aes(x=x, y=med, color=group, alpha=block, group=block)) +
  geom_line() +
  facet_grid(.~group)


# facet by block
most_block_dat %>%
  ggplot(aes(x=vot, y=resp_p, color=group, group=interaction(group, block))) +
  geom_line(stat='summary', fun.y=mean) +
  facet_grid(.~block)

most_block_class_summary %>%
  ggplot(aes(x=x, y=med, color=group, group=interaction(group, block))) +
  geom_line() +
  facet_grid(.~block)


most_block_dat %>%
  ggplot(aes(x=vot, y=resp_p, color=group, group=interaction(group, block))) +
  geom_pointrange(stat='summary', fun.data='mean_cl_boot') +
  geom_line(data = most_block_class_summary, aes(x=x, y=med)) +
  facet_grid(.~block)

```
